@model List<Curate.Data.ViewModels.RssFeed.FeedCategoryViewModel>
@{
    ViewData["Title"] = "RSS Feeds";
}

@section Styles {

}

<!-- Content Header (Page header) -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>RSS Feeds</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                    <li class="breadcrumb-item active">RSS Feeds</li>
                </ol>
            </div>
        </div>
    </div><!-- /.container-fluid -->
</section>

<!-- Main content -->
<section class="content">

    <div class="card-body p-0">
        <div class="row">
            <!-- left column -->
            <div class="col-md-3">

                <div class="card">
                    <div class="card-header">
                        <a href="@Url.Action("ScanAll","Feed")" class="btn btn-success btn-xs">Scan All Feeds</a>

                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0" style="height:650px;overflow-y: scroll;">
                        <ul data-widget="treeview" id="feedTreeview" data-accordion="true">
                            @foreach (var category in Model)
                            {
                                <li class="treeview">
                                    <a href="#">@category.Title</a>
                                    <ul class="treeview-menu nav-link">
                                        @foreach (var subcategory in category.SubCategories)
                                        {
                                            <li>
                                                <a href="#">@subcategory.Title</a>
                                                <ul class="treeview-menu nav-link">

                                                    @foreach (var feed in subcategory.Feeds)
                                                    {
                                                        if (feed.Blocked)
                                                        {
                                                            <li><strike>@feed.Title</strike></li>
                                                        }
                                                        else
                                                        {
                                                           
                                                            <li><a onclick="selectFeed(@feed.Id);return false;">@feed.Title <span title="@feed.Articles.Count" class="badge bg-success">@feed.Articles.Count</span></a></li>
                                                        }
                                                    }
                                                </ul>
                                            </li>
                                        }
                                    </ul>
                                </li>
                            }
                        </ul>
                        @*<ul class="nav nav-pills flex-column">
                            <li class="nav-item active">
                            <a href="#" class="nav-link">
                            <i class="fas fa-inbox"></i> Inbox
                            <span class="badge bg-primary float-right">12</span>
                            </a>
                            </li>
                            <li class="nav-item">
                            <a href="#" class="nav-link">
                            <i class="far fa-envelope"></i> Sent
                            </a>
                            </li>
                            <li class="nav-item">
                            <a href="#" class="nav-link">
                            <i class="far fa-file-alt"></i> Drafts
                            </a>
                            </li>
                            <li class="nav-item">
                            <a href="#" class="nav-link">
                            <i class="fas fa-filter"></i> Junk
                            <span class="badge bg-warning float-right">65</span>
                            </a>
                            </li>
                            <li class="nav-item">
                            <a href="#" class="nav-link">
                            <i class="far fa-trash-alt"></i> Trash
                            </a>
                            </li>
                            </ul>*@
                    </div>
                    <!-- /.card-body -->
                </div>

            </div>
            <div class="col-md-9">
                <!-- Horizontal Form -->
                <div class="card card-primary card-outline" id="articles_card">
                    <div class="card-header">
                        <h3 class="card-title" id="selectedFeedTitle">Articles</h3>
                    </div>
                    <div id="divArticles" class="card-body p-0">
                        <table id="tblArticles" class="table table-striped projects">
                            <tbody></tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>
<!-- /.content -->
@section scripts
{
<script type="text/javascript">
    $(document).ready(function () {
        $('ul').Treeview({
            "trigger":"[data-widget='treeview'] .nav-link"
        });
        @if (Model.Count() > 0)
        {
            @:selectFeed(@Model.First().Id);
        }
    });

    function getSelectedFeed() {
        return $('#selectedFeedId').val();
    }

    function showArticlesLoadingOverlay(){
        var overlayDiv = "<div class='overlay'><i class='fas fa-2x fa-sync-alt fa-spin'></i></div>";
        var articlesCard = $('#articles_card')
    }
    function hideArticlesLoadingOverlay(){

    }

    function selectFeed(feedId) {
        $('#selectedFeedId').val(feedId);

        $.ajax({
            type: "GET",
            url: '/admin/feed/GetOneFeed?feedId=' + feedId,
            contentType: "application/json",
            dataType: "json",
            beforeSend: function() {
              showArticlesLoadingOverlay();
           },
            success: function (response) {
                $('#tblArticles tr').remove();
                $('#selectedFeedTitle').text(response.title);
                if(response.articles.length > 0){
                $.each(response.articles, function (i, article) {

                    var contentId = 'article' + article.id;

                    var font = 'font-weight: bold';
                    if (article.isProcessed) font = 'font-weight: normal';
                    var articleTitleCell = '<td><div id="articlehead' + article.id + '" style="cursor:pointer;' + font + '"onclick="markAsRead(this,' + article.id + ');  showOrHide(\'' + contentId + '\');' + '">';
                    articleTitleCell += article.title;
                    articleTitleCell += "&nbsp;";
                    articleTitleCell += '<a href="' + article.url + '" target="_blank">';
                    articleTitleCell += '<span class="fa fa-external-link-alt"></span>';
                    articleTitleCell += "</a>"
                    articleTitleCell += "</div>";
                    articleTitleCell += '<div style="display:none" id="' + contentId + '"></td>';

                    var publishDateCell = "<td>"+article.formattedPublishDate+"</td>";
                    var hasBeenFeaturedCell = "<td></td>";
                    if(article.hasBeenFeatured){
                        hasBeenFeaturedCell = "<td><span class='badge badge-danger'>"+ article.formattedLastFeaturedDate +"</span></td>";
                    }
                    var actionButtonsCell ="<td><a onclick='AddToFeatured()' class='btn btn-success btn-xs'>Add to Featured</a></td>";

                    var articleRow = "<tr>" + articleTitleCell + publishDateCell + hasBeenFeaturedCell + actionButtonsCell +"</tr>";
                    $('#tblArticles').append(articleRow);
                });
                }else{
                    $('#tblArticles').append("<tr><td><div class='alert alert-warning'><h5> No Articles Found </h5></div></td></tr>");
                }
            },
            failure: function (response) {
                $('#tblArticles').append("<tr><td><div class='alert alert-danger'><h5> Something went wrong! </h5></div></td></tr>");
            },
             complete: function(){
                 hideArticlesLoadingOverlay();
             }
        });
    }
</script>
}
